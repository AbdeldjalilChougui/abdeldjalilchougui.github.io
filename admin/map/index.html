<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Visitor Analytics</title>
  <link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css"/>
  <style>
    #map { height: 500px; }
  </style>
</head>
<body>
  <h1>Visitor Countries</h1>
  <select id="filter">
    <option value="today">Today</option>
    <option value="yesterday">Yesterday</option>
    <option value="7days" selected>Last 7 Days</option>
    <option value="month">This Month</option>
    <option value="all">All Time</option>
  </select>

  <div id="map"></div>

  <script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>
  <script>
    const API_URL = "https://your-api.vercel.app/api/analytics";

    const map = L.map('map').setView([20, 0], 2);

    L.tileLayer("https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png", {
      attribution: "&copy; OpenStreetMap contributors"
    }).addTo(map);

    async function loadData(filter = "7days") {
      const res = await fetch(`${API_URL}?filter=${filter}`);
      const data = await res.json();

      console.log("Analytics data:", data);

      data.forEach(item => {
        // You’ll need a country → lat/lon mapping
        fetch(`https://nominatim.openstreetmap.org/search?country=${item.country}&format=json&limit=1`)
          .then(r => r.json())
          .then(geo => {
            if (geo.length > 0) {
              const { lat, lon } = geo[0];
              L.circleMarker([lat, lon], {
                radius: Math.min(20, item.users / 5),
                fillColor: "red",
                color: "red",
                weight: 1,
                opacity: 1,
                fillOpacity: 0.6
              })
              .bindPopup(`${item.country}: ${item.users} users`)
              .addTo(map);
            }
          });
      });
    }

    document.getElementById("filter").addEventListener("change", (e) => {
      map.eachLayer(layer => { if (layer instanceof L.CircleMarker) map.removeLayer(layer); });
      loadData(e.target.value);
    });

    loadData(); // default 7 days
  </script>
</body>
</html>
